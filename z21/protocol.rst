=====================
Roco Z21 LAN Protocol
=====================


Data Fromat
===========

Little endian encoding is used.


Basic Packet Structure
======================

+--------+-------------+-------+------------------------------------+
| Offset | Field       | Width | Description                        |
+========+=============+=======+====================================+
| 0      | Data Length | 2     | Length of packet including header. |
+--------+-------------+-------+------------------------------------+
| 2      | Packet Type | 2     | See `Packet Types`_                |
+--------+-------------+-------+------------------------------------+
| 4      | Payload     | \<n>  |                                    |
+--------+-------------+-------+------------------------------------+


Packet Types
============

+------+--------------------------------+
| Id   | Type                           |
+======+================================+
| 0x10 | `LAN_GET_SERIAL_NUMBER`_       |
+------+--------------------------------+
| 0x1A | `LAN_GET_HWINFO`_              |
+------+--------------------------------+
| 0x30 | `LAN_LOGOFF`_                  |
+------+--------------------------------+
| 0x40 | See `X-Bus Packet Types`_      |
+------+--------------------------------+
| 0x50 | `LAN_SET_BROADCASTFLAGS`_      |
+------+--------------------------------+
| 0x51 | `LAN_GET_BROADCASTFLAGS`_      |
+------+--------------------------------+
| 0x60 | `LAN_GET_LOCOMODE`_            |
+------+--------------------------------+
| 0x61 | `LAN_SET_LOCOMODE`_            |
+------+--------------------------------+
| 0x70 | `LAN_GET_TURNOUTMODE`_         |
+------+--------------------------------+
| 0x71 | `LAN_SET_TURNOUTMODE`_         |
+------+--------------------------------+
| 0x80 | `LAN_RMBUS_DATACHANGED`_       |
+------+--------------------------------+
| 0x81 | `LAN_RMBUS_GETDATA`_           |
+------+--------------------------------+
| 0x82 | `LAN_RMBUS_PROGRAMMODULE`_     |
+------+--------------------------------+
| 0x84 | `LAN_SYSTEMSTATE_DATACHANGED`_ |
+------+--------------------------------+
| 0x85 | `LAN_SYSTEMSTATE_GETDATA`_     |
+------+--------------------------------+
| 0x88 | `LAN_RAILCOM_DATACHANGED`_     |
+------+--------------------------------+
| 0x89 | `LAN_RAILCOM_GETDATA`_         |
+------+--------------------------------+
| 0xA0 | `LAN_LOCONET_Z21_RX`_          |
+------+--------------------------------+
| 0xA1 | `LAN_LOCONET_Z21_TX`_          |
+------+--------------------------------+
| 0xA2 | `LAN_LOCONET_FROM_LAN`_        |
+------+--------------------------------+
| 0xA3 | `LAN_LOCONET_DISPATCH_ADDR`_   |
+------+--------------------------------+
| 0xA4 | `LAN_LOCONET_DETECTOR`_        |
+------+--------------------------------+


X-Bus Packet Types
==================


LAN_GET_SERIAL_NUMBER
=====================

+--------+---------------+-------+----------------------+
| Request                                               |
+--------+---------------+-------+----------------------+
| Offset | Field         | Width | Value                |
+========+===============+=======+======================+
| 0      | Data Length   | 2     | 0x0004               |
+--------+---------------+-------+----------------------+
| 2      | Packet Type   | 2     | 0x0010               |
+--------+---------------+-------+----------------------+

+--------+---------------+-------+----------------------+
| Response                                              |
+--------+---------------+-------+----------------------+
| Offset | Field         | Width | Value                |
+========+===============+=======+======================+
| 0      | Data Length   | 2     | 0x0008               |
+--------+---------------+-------+----------------------+
| 2      | Packet Type   | 2     | 0x0010               |
+--------+---------------+-------+----------------------+
| 4      | Serial Number | 4     | uint32 serial number |
+--------+---------------+-------+----------------------+

Reads the serial number of the Z21.  The serial number is returned as an
unsigned 32 bit integer.


LAN_GET_HWINFO
==============

Reads the hardware type and firmware version of the Z21.

HW Types
--------

+-----------------+------------+------------------------------------+
| HW Type         | Value      | Description                        |
+=================+============+====================================+
| D_HWT_Z21_OLD   | 0x00000200 | Z21 (hardware variant from 2012)   |
+-----------------+------------+------------------------------------+
| D_HWT_Z21_NEW   | 0x00000201 | Z21 (hardware variant from 2012)   |
+-----------------+------------+------------------------------------+
| D_HWT_SMARTRAIL | 0x00000202 | SmartRail (from 2012)              |
+-----------------+------------+------------------------------------+
| D_HWT_z21_SMALL | 0x00000203 | z21 Starterset variant (from 2013) |
+-----------------+------------+------------------------------------+

+--------+---------------+-------+----------------------+
| Request                                               |
+--------+---------------+-------+----------------------+
| Offset | Field         | Width | Value                |
+========+===============+=======+======================+
| 0      | Data Length   | 2     | 0x0004               |
+--------+---------------+-------+----------------------+
| 2      | Packet Type   | 2     | 0x001A               |
+--------+---------------+-------+----------------------+

+--------+---------------+-------+----------------------+
| Response                                              |
+--------+---------------+-------+----------------------+
| Offset | Field         | Width | Value                |
+========+===============+=======+======================+
| 0      | Data Length   | 2     | 0x000C               |
+--------+---------------+-------+----------------------+
| 2      | Packet Type   | 2     | 0x001A               |
+--------+---------------+-------+----------------------+
| 4      | HW Type       | 4     | [HW Type](#hw-types) |
+--------+---------------+-------+----------------------+
| 8      | FW Minor Ver  | 1     | BCD integer          |
+--------+---------------+-------+----------------------+
| 9      | FW Major Ver  | 3     | BCD integer          |
+--------+---------------+-------+----------------------+


LAN_LOGOFF
==========

Causes the Z21 to stop sending packets to the client.  Logging on is done
implicitly when the Z21 receives the first command from a client.

Request
-------

+--------+---------------+-------+----------------------+
| Offset | Field         | Width | Value                |
+========+===============+=======+======================+
| 0      | Data Length   | 2     | 0x0004               |
+--------+---------------+-------+----------------------+
| 2      | Packet Type   | 2     | 0x0030               |
+--------+---------------+-------+----------------------+


LAN_SET_BROADCASTFLAGS
======================

Boradcast Flags
---------------

| Bit | Description  |
|-----|--------------|
| 0   | Driving and switching |
| 1   | R-Bus feedback |
| 3   | RailCom data |
| 8   | Z21 System State |
| 16  | When set with bit 0, sends data for all locos (instead of just addresed ones) |
